{% comment %}
Reusable responsive image include.
Parameters:
- src: string; image path relative to /images (e.g., "profile.png") or absolute URL
- alt: string; required alt text
- class: optional CSS class string
- width, height: optional explicit intrinsic dimensions; if absent for local images, will be looked up from site.data.images
- sizes: optional sizes attribute; defaults to "(max-width: 800px) 100vw, 800px"
- priority: boolean; if true, set fetchpriority="high" and do not lazy-load
- loading: optional; default "lazy" unless priority
- decoding: optional; default "async"
- base_path: from include of base_path

Variant convention for local images:
If site.data.images[src].variants is defined (array of widths), the include will emit a srcset referencing
"<name>-<width>w.<ext> <width>w" assuming files exist alongside the original under /images.
{% endcomment %}

{% include base_path %}

{% assign is_remote = include.src | to_s | contains: "://" %}
{% assign decoding = include.decoding | default: 'async' %}
{% assign sizes = include.sizes | default: '(max-width: 800px) 100vw, 800px' %}
{% assign css_class = include.class %}
{% assign loading = include.loading %}
{% if include.priority %}
  {% assign fetchpriority = 'high' %}
  {% assign loading_attr = '' %}
{% else %}
  {% assign fetchpriority = 'auto' %}
  {% assign loading_attr = loading | default: 'lazy' %}
{% endif %}

{% if is_remote %}
  <img src="{{ include.src }}" alt="{{ include.alt }}"{% if css_class %} class="{{ css_class }}"{% endif %}{% if loading_attr %} loading="{{ loading_attr }}"{% endif %} decoding="{{ decoding }}" fetchpriority="{{ fetchpriority }}" />
{% else %}
  {% assign img_src = include.src %}
  {% assign data = site.data.images[img_src] %}
  {% assign width = include.width | default: data.width %}
  {% assign height = include.height | default: data.height %}

  {%- comment -%} Compute src and srcset {%- endcomment -%}
  {% assign ext = img_src | split: '.' | last %}
  {% capture dotext %}.{{ ext }}{% endcapture %}
  {% assign name = img_src | replace: dotext, '' %}

  {% assign variants = data.variants %}
  {% assign srcset = nil %}
  {% if variants %}
    {% assign parts = '' %}
    {% for w in variants %}
      {% capture url %}{{ name }}-{{ w }}w.{{ ext }}{% endcapture %}
      {% capture part %}{{ url | prepend: '/images/' | prepend: base_path }} {{ w }}w{% endcapture %}
      {% if forloop.first %}
        {% assign parts = part %}
      {% else %}
        {% assign parts = parts | append: ', ' | append: part %}
      {% endif %}
    {% endfor %}
    {% assign srcset = parts %}
  {% endif %}

  <img src="{{ img_src | prepend: '/images/' | prepend: base_path }}" alt="{{ include.alt }}"{% if css_class %} class="{{ css_class }}"{% endif %}{% if width and height %} width="{{ width }}" height="{{ height }}"{% endif %}{% if srcset %} srcset="{{ srcset }}" sizes="{{ sizes }}"{% endif %}{% if loading_attr %} loading="{{ loading_attr }}"{% endif %} decoding="{{ decoding }}" fetchpriority="{{ fetchpriority }}" />
{% endif %}
